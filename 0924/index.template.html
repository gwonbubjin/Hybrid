<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>ëŒ€í•œë¯¼êµ­ ëŒ€ê¸°ì§ˆ ëŒ€ì‹œë³´ë“œ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { margin:0; font-family:"Noto Sans KR", sans-serif; background:#f3f4f6; color:#111827;}

  /* í—¤ë” */
  header { 
    background:#1e3a8a; color:white; 
    padding:15px 20px; 
    display:flex; justify-content:space-between; align-items:center; 
    box-shadow:0 2px 6px rgba(0,0,0,0.3);
  }
  header h1 { margin:0; font-size:1.6rem; font-weight:700;}
  #navBtns button { 
    margin-left:8px; padding:6px 12px; 
    border:none; border-radius:6px; cursor:pointer; 
    font-weight:600; font-size:0.9rem;
  }
  #homeBtn { background:#facc15; color:#111; }
  #backBtn { background:#22c55e; color:white; }

  /* ì•ˆë‚´ ë°°ë„ˆ */
  #desc { background:#1e40af; color:white; padding:10px 20px; font-size:0.9rem; text-align:center; }

  /* í™ˆ í™”ë©´ */
  #homeHero {
    text-align:center; padding:40px 20px 20px;
  }
  #homeHero h2 {
    font-size:1.8rem; margin:10px 0; color:#1e3a8a;
  }
  #homeHero p {
    font-size:1rem; color:#374151; margin:0;
  }
  #todayInfo {
    margin-top:8px; font-size:0.9rem; color:#6b7280;
  }

  /* ì „êµ­ ìš”ì•½ */
  #nationSummaryBox {
    max-width:600px; margin:20px auto; 
    background:white; padding:16px; 
    border-radius:12px; 
    box-shadow:0 2px 10px rgba(0,0,0,0.08);
    text-align:center; font-size:1rem;
  }

  /* ì‹œ/ë„ ë²„íŠ¼ ì˜ì—­ */
  #regions { 
    display:grid; grid-template-columns:repeat(auto-fill, minmax(120px, 1fr)); 
    gap:16px; max-width:800px; margin:30px auto; padding:0 20px;
  }
  .region { 
    background:white; border:2px solid #1e3a8a; color:#1e3a8a; 
    border-radius:10px; padding:14px 0; text-align:center; 
    font-weight:700; cursor:pointer; transition:.2s;
    box-shadow:0 1px 4px rgba(0,0,0,0.05);
  }
  .region:hover { background:#1e3a8a; color:white; transform:translateY(-3px) scale(1.03);}

  /* ë°ì´í„° í™”ë©´ ìƒë‹¨ ì—¬ë°± + ê²€ìƒ‰ ì˜ì—­ */
  #dataScreen { padding-top: 20px; }
  #controls { 
    margin:20px auto 0; padding:16px; 
    max-width:900px; width:92%;
    background:white; border-radius:12px; 
    box-shadow:0 2px 10px rgba(0,0,0,0.08);
    display:flex; flex-wrap:wrap; justify-content:center; gap:12px;
  }
  #searchBox, #sortSelect { 
    padding:10px 14px; border:1px solid #d1d5db; border-radius:8px; font-size:1rem;
  }
  #searchBox { flex:1; min-width:240px; }
  #sortSelect { min-width:180px; }

  /* ìš”ì•½ ì¹´ë“œ */
  #summary { 
    padding:20px; display:flex; justify-content:center; gap:20px; flex-wrap:wrap;
    max-width:1100px; margin:16px auto 0;
  }
  .summary-card { flex:1; min-width:260px; background:white; border-radius:12px; padding:16px; box-shadow:0 2px 6px rgba(0,0,0,0.12);}
  .summary-card h3 { margin:0 0 10px; font-size:1.2rem;}

  /* ì—…ë°ì´íŠ¸ ë¼ì¸ */
  #lastUpdate { font-size:0.85rem; color:#555; text-align:center; margin:8px 0 0; }

  /* ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ */
  #info { 
    padding:20px; display:grid; grid-template-columns:repeat(auto-fill, minmax(260px, 1fr)); gap:16px;
    max-width:1100px; margin:12px auto 30px;
  }
  #info h2 { grid-column:1/-1; margin:8px 0 4px; }

  .card { border-radius:12px; padding:16px; box-shadow:0 2px 6px rgba(0,0,0,0.1); cursor:pointer; transition:.2s; }
  .card:hover { transform:translateY(-4px) scale(1.02);}
  .title { font-weight:700; font-size:1.1rem; margin-bottom:6px;}
  .muted { font-size:0.85rem; color:#6b7280; margin-bottom:10px;}
  .chip { display:inline-block; padding:6px 10px; border-radius:999px; font-size:0.9rem; font-weight:600; margin-bottom:8px;}
  .good { background:#d1fae5; color:#065f46;}
  .normal { background:#fef9c3; color:#854d0e;}
  .bad { background:#fee2e2; color:#991b1b;}
  .verybad { background:#f5d0fe; color:#701a75;}
  .good-bg { background:#ecfdf5;}
  .normal-bg { background:#fefce8;}
  .bad-bg { background:#fef2f2;}
  .verybad-bg { background:#fdf4ff;}

  /* ëª¨ë‹¬ */
  #modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); justify-content:center; align-items:center;}
  #modalContent { background:white; padding:20px; border-radius:12px; max-width:640px; width:92%; max-height:90%; overflow-y:auto; box-shadow:0 10px 24px rgba(0,0,0,.2);}
  #closeModal { float:right; cursor:pointer; font-weight:bold; }
  #modalBody h3 { margin-top:0;}
</style>
</head>
<body>
<header>
  <h1>ëŒ€í•œë¯¼êµ­ ëŒ€ê¸°ì§ˆ ëŒ€ì‹œë³´ë“œ</h1>
  <div id="navBtns">
    <button id="homeBtn" onclick="goHome()">ğŸ  í™ˆ</button>
    <button id="backBtn" onclick="goBack()">â¬… ë’¤ë¡œê°€ê¸°</button>
  </div>
</header>
<div id="desc">
  â€» í™˜ê²½ë¶€ ê³µê³µë°ì´í„°í¬í„¸ <b>ì‹¤ì‹œê°„ ëŒ€ê¸°ì˜¤ì—¼ì •ë³´ API</b> ì‚¬ìš© Â· ëª¨ë“  ë™Â·ìÂ·ë©´ì´ ì•„ë‹Œ <b>ì¸¡ì •ì†Œ ì„¤ì¹˜ ì§€ì—­ë§Œ</b> ë°ì´í„° ì œê³µ
</div>

<!-- í™ˆí™”ë©´ -->
<div id="homeScreen">
  <div id="homeHero">
    <div style="font-size:48px;">ğŸŒ</div>
    <h2>ì‹¤ì‹œê°„ ëŒ€í•œë¯¼êµ­ ëŒ€ê¸°ì§ˆ</h2>
    <p>ê¹¨ë—í•œ ê³µê¸°, ì•ˆì „í•œ ìƒí™œì„ ìœ„í•œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</p>
    <div id="todayInfo"></div>
  </div>

  <div id="nationSummaryBox">
    <span id="nationSummary">ì „êµ­ ëŒ€ê¸°ì§ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
  </div>

  <h3 style="text-align:center; margin-top:30px;">ì‹œ/ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
  <div id="regions">
    <div class="region">ì„œìš¸</div><div class="region">ë¶€ì‚°</div><div class="region">ëŒ€êµ¬</div>
    <div class="region">ì¸ì²œ</div><div class="region">ê´‘ì£¼</div><div class="region">ëŒ€ì „</div>
    <div class="region">ìš¸ì‚°</div><div class="region">ì„¸ì¢…</div><div class="region">ê²½ê¸°</div>
    <div class="region">ê°•ì›</div><div class="region">ì¶©ë¶</div><div class="region">ì¶©ë‚¨</div>
    <div class="region">ì „ë¶</div><div class="region">ì „ë‚¨</div><div class="region">ê²½ë¶</div>
    <div class="region">ê²½ë‚¨</div><div class="region">ì œì£¼</div>
  </div>
</div>

<!-- ë°ì´í„°í™”ë©´ -->
<div id="dataScreen" style="display:none;">
  <div id="controls">
    <input type="text" id="searchBox" placeholder="ì¸¡ì •ì†Œ ê²€ìƒ‰ (ì˜ˆ: íƒœì¢…ëŒ€)">
    <select id="sortSelect">
      <option value="">ì •ë ¬ ì—†ìŒ</option>
      <option value="pm10">PM10 ë†’ì€ ìˆœ</option>
      <option value="pm25">PM2.5 ë†’ì€ ìˆœ</option>
      <option value="o3">ì˜¤ì¡´ ë†’ì€ ìˆœ</option>
    </select>
  </div>
  <div id="summary"></div>
  <div id="lastUpdate"></div>
  <div id="info"></div>
</div>

<!-- ëª¨ë‹¬ -->
<div id="modal"><div id="modalContent">
  <span id="closeModal">X</span>
  <div id="modalBody"></div>
</div></div>

<script>
/* =========================
   ğŸ”’ ë¸Œë¼ìš°ì €ì—ì„œëŠ” API í‚¤ë¥¼ ì“°ì§€ ì•ŠìŒ (ìŠ¤ëƒ…ìƒ· SEEDë§Œ ì‚¬ìš©)
   ========================= */
let currentItems = [];
let currentSido = "";
let chartDetail = null;
let screenHistory = [];

/* SEED(JSON ìŠ¤ëƒ…ìƒ·)ë¥¼ ì•ˆì „í•˜ê²Œ ì½ëŠ” í—¬í¼ */
function getSeed(){
  const tag = document.getElementById("SEED_DATA");
  if(!tag) return null;
  try { return JSON.parse(tag.textContent); }
  catch(e){ return null; }
}

/* ë‚´ë¹„ê²Œì´ì…˜ */
function goHome(){
  document.getElementById("homeScreen").style.display="block";
  document.getElementById("dataScreen").style.display="none";
  screenHistory = [];
}
function goBack(){
  if(screenHistory.length>1){
    screenHistory.pop();
    const prev = screenHistory.pop();
    if(prev) loadData(prev);
  } else {
    goHome();
  }
}

/* ë“±ê¸‰ í‘œì‹œ */
function gradeClass(grade){
  switch(String(grade)){
    case "1": return {cls:"good", text:"ì¢‹ìŒ âœ…", bg:"good-bg"};
    case "2": return {cls:"normal", text:"ë³´í†µ ğŸ˜", bg:"normal-bg"};
    case "3": return {cls:"bad", text:"ë‚˜ì¨ âš ï¸", bg:"bad-bg"};
    case "4": return {cls:"verybad", text:"ë§¤ìš°ë‚˜ì¨ âŒ", bg:"verybad-bg"};
    default: return {cls:"", text:"-", bg:""};
  }
}

/* ë¦¬ìŠ¤íŠ¸ ë Œë” */
function renderItems(items, sido){
  const info = document.getElementById("info");
  if(!items || items.length===0){ info.innerHTML="<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>"; return; }

  const toNum = v => Number(v ?? NaN);
  let sortable = items.filter(x => !isNaN(toNum(x.pm10Value)));
  let sorted = sortable.sort((a,b)=>toNum(a.pm10Value)-toNum(b.pm10Value));
  let best = sorted[0] || {stationName:"-", pm10Value:"-", pm25Value:"-"};
  let worst = sorted[sorted.length-1] || {stationName:"-", pm10Value:"-", pm25Value:"-"};

  document.getElementById("summary").innerHTML = `
    <div class="summary-card">
      <h3>âœ… ê°€ì¥ ê³µê¸° ì¢‹ì€ ê³³</h3>
      <p><b>${best.stationName}</b><br>PM10: ${best.pm10Value}, PM2.5: ${best.pm25Value}</p>
    </div>
    <div class="summary-card">
      <h3>âŒ ê°€ì¥ ê³µê¸° ë‚˜ìœ ê³³</h3>
      <p><b>${worst.stationName}</b><br>PM10: ${worst.pm10Value}, PM2.5: ${worst.pm25Value}</p>
    </div>
  `;

  info.innerHTML = `<h2>${sido} ëŒ€ê¸°ì§ˆ (${items.length}ê°œ ì¸¡ì •ì†Œ)</h2>`+
    items.map(it=>{
      const g=gradeClass(it.khaiGrade);
      const safeName = String(it.stationName || "").replace(/'/g,"&#39;");
      return `<div class="card ${g.bg}" onclick="openModal('${safeName}')">
        <div class="title">${it.stationName}</div>
        <div class="muted">${it.dataTime || ""}</div>
        <span class="chip ${g.cls}">${g.text}</span>
        <div>PM10: ${it.pm10Value??"-"}</div>
        <div>PM2.5: ${it.pm25Value??"-"}</div>
        <div>ì˜¤ì¡´(Oâ‚ƒ): ${it.o3Value??"-"}</div>
      </div>`;
    }).join("");
}

/* ë°ì´í„° ë¡œë“œ: SEEDë§Œ ì‚¬ìš© */
async function loadData(sido){
  const SEED = getSeed();
  currentSido=sido;
  document.getElementById("homeScreen").style.display="none";
  document.getElementById("dataScreen").style.display="block";
  screenHistory.push(sido);

  try{
    if(!SEED || !SEED.data || !SEED.data[sido]) throw new Error("no baked data");
    currentItems = SEED.data[sido].response?.body?.items || [];
    renderItems(currentItems,sido);
    document.getElementById("lastUpdate").innerText="ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: "+(SEED.updatedAt || "");
  }catch(err){
    document.getElementById("info").innerHTML=`<p>ë°ì´í„° ì—†ìŒ(ìŠ¤ëƒ…ìƒ· ë¯¸ì£¼ì…). Actions ë¹Œë“œ í›„ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.</p>`;
  }
}

/* ê²€ìƒ‰ */
document.getElementById("searchBox").addEventListener("input",e=>{
  const k=e.target.value.trim();
  if(k===""){renderItems(currentItems,currentSido);return;}
  const f=currentItems.filter(it=>(it.stationName||"").includes(k));
  renderItems(f,"ê²€ìƒ‰ ê²°ê³¼");
});

/* ì •ë ¬ */
document.getElementById("sortSelect").addEventListener("change",e=>{
  let v=e.target.value;
  let sorted=[...currentItems];
  const asNum = (x)=>Number(x??NaN);
  if(v==="pm10") sorted.sort((a,b)=>asNum(b.pm10Value)-asNum(a.pm10Value));
  if(v==="pm25") sorted.sort((a,b)=>asNum(b.pm25Value)-asNum(a.pm25Value));
  if(v==="o3")   sorted.sort((a,b)=>asNum(b.o3Value)-asNum(a.o3Value));
  renderItems(sorted,currentSido);
});

/* ìƒì„¸ ëª¨ë‹¬ */
function openModal(name){
  const it=currentItems.find(x=>x.stationName===name);
  if(!it) return;
  const g=gradeClass(it.khaiGrade);

  document.getElementById("modalBody").innerHTML=`
    <h3>${it.stationName}</h3>
    <p>${it.dataTime || ""}</p>
    <p>ë“±ê¸‰: <span class="${g.cls}">${g.text}</span></p>
    <canvas id="detailChart" width="400" height="300"></canvas>
  `;
  document.getElementById("modal").style.display="flex";

  if(chartDetail) chartDetail.destroy();
  const vals = [
    Number(it.pm10Value)||0, Number(it.pm25Value)||0, Number(it.o3Value)||0,
    Number(it.coValue)||0, Number(it.so2Value)||0, Number(it.no2Value)||0
  ];
  chartDetail = new Chart(document.getElementById("detailChart"), {
    type:'bar',
    data:{
      labels:["PM10","PM2.5","ì˜¤ì¡´(Oâ‚ƒ)","CO","SOâ‚‚","NOâ‚‚"],
      datasets:[{ 
        label:"ì¸¡ì •ê°’",
        data: vals,
        backgroundColor:["#3b82f6","#22c55e","#facc15","#f97316","#a855f7","#ef4444"]
      }]
    },
    options:{responsive:true, scales:{y:{beginAtZero:true}}}
  });
}
document.getElementById("closeModal").onclick=()=>{document.getElementById("modal").style.display="none";};
document.getElementById("modal").onclick=e=>{if(e.target.id==="modal") document.getElementById("modal").style.display="none";};

/* ìë™ ìƒˆë¡œê³ ì¹¨ (ìŠ¤ëƒ…ìƒ· ëª¨ë“œì—ì„  ë¹„í™œì„± ê¶Œì¥) */
// setInterval(()=>{ if(currentSido) loadData(currentSido); }, 300000);

/* í™ˆ í™”ë©´: ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ */
function updateDateTime(){
  const now = new Date();
  const opt = { year:"numeric", month:"long", day:"numeric", hour:"2-digit", minute:"2-digit" };
  document.getElementById("todayInfo").innerText = now.toLocaleDateString("ko-KR", opt) + " ê¸°ì¤€";
}
updateDateTime();
setInterval(updateDateTime, 60000);

/* ì „êµ­ ìš”ì•½ (ì„œìš¸) - SEED ì‚¬ìš© */
async function loadNationSummary(){
  const SEED = getSeed();
  try {
    const items = SEED?.data?.["ì„œìš¸"]?.response?.body?.items || [];
    const avgPm10 = items.length
      ? Math.round(items.reduce((s,it)=>s+Number(it.pm10Value||0),0)/items.length)
      : NaN;
    const grade = isNaN(avgPm10) ? "-" : (avgPm10<=30 ? "ì¢‹ìŒ âœ…" : avgPm10<=80 ? "ë³´í†µ ğŸ˜" : "ë‚˜ì¨ âš ï¸");
    document.getElementById("nationSummary").innerText =
      isNaN(avgPm10) ? "ì „êµ­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." : `ì˜¤ëŠ˜ ì„œìš¸ í‰ê·  PM10: ${avgPm10} (${grade})`;
  } catch {
    document.getElementById("nationSummary").innerText = "ì „êµ­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
  }
}
loadNationSummary();

/* ì§€ì—­ í´ë¦­ */
document.querySelectorAll(".region").forEach(el=>el.addEventListener("click",()=>loadData(el.textContent)));
</script>

<!-- seed(ìŠ¤ëƒ…ìƒ·) ë°ì´í„°ê°€ ì—¬ê¸°ì— ì£¼ì…ë©ë‹ˆë‹¤ -->
<script id="SEED_DATA" type="application/json">__SEED_JSON__</script>
</body>
</html>
